<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Feed Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
</head>
<body>
  <article id="form">
    <header style="text-align:center;">
    <img height="15%" width="15%" src="public/logo.png">
    <h1>Feed Builder</h1>
    <p>Enter the details below to create a new RSS feed</p>
    </header>
    <main style="padding-left:30vw;padding-right:30vw;">
<form action="/" method="post">
    <!-- Feed Name -->
    <label for="feedName">Feed Name:</label>
    <input type="text" name="feedName" id="feedName" required><br><br>
    <!-- Feed URL -->
    <label for="feedUrl">Target URL:</label>
    <input type="text" name="feedUrl" id="feedUrl" required><br><br>
    <!-- CSSTarget Fields -->
    <label for="feedType">Feed Type:</label>
    <select name="feedType" id="feedType" value="webScraping">
      <option value="webScraping">Web Scraping</option>
      <option value="api">REST API Call</option>
    </select><br><br>
    <div id="webScrapingFields">
    <h3>CSS Selectors for RSS Feed Items</h3>
    <!-- Iterator Selector -->
    <label for="itemSelector">Item Selector (Iterator):</label>
    <input type="text" name="itemSelector" id="itemSelector"><br><br>
    <!-- Title Selector -->
    <label for="titleSelector">Title Selector:</label>
    <input type="text" name="titleSelector" id="titleSelector"><br><br>
    <label for="titleAttribute">Title Attribute:</label>
    <input type="text" name="titleAttribute" id="titleAttribute"><br><br>
    <label for="titleIterator">Title Parent Iterator (optional):</label>
    <input type="text" name="titleIterator" id="titleIterator"><br><br>
    <label>
      <input type="checkbox" name="titleStripHtml" id="titleStripHtml"> Strip HTML in Title
    </label><br><br>
    <label>
      <input type="checkbox" name="titleTitleCase" id="titleTitleCase"> Convert Title to Title Case
    </label><br><br>
    <details>
      <summary>Description</summary>
    <label for="descriptionSelector">Description Selector:</label>
    <input type="text" name="descriptionSelector" id="descriptionSelector"><br><br>
    <label for="descriptionAttribute">Description Attribute:</label>
    <input type="text" name="descriptionAttribute" id="descriptionAttribute"><br><br>
    <label for="descriptionIterator">Description Parent Iterator (optional):</label>
    <input type="text" name="descriptionIterator" id="descriptionIterator"><br><br>
    <label>
      <input type="checkbox" name="descriptionStripHtml" id="descriptionStripHtml"> Strip HTML in Description
    </label><br><br>
    <label>
      <input type="checkbox" name="descriptionTitleCase" id="descriptionTitleCase"> Convert Description to Title Case
    </label>
    </details>
    <br><br>
    <details>
      <summary>Link</summary>
    <label for="linkSelector">Link Selector:</label>
    <input type="text" name="linkSelector" id="linkSelector"><br><br>
    <label for="linkAttribute">Link Attribute:</label>
    <input type="text" name="linkAttribute" id="linkAttribute"><br><br>
    <label for="linkIterator">Link Parent Iterator (optional):</label>
    <input type="text" name="linkIterator" id="linkIterator"><br><br>
    <label>
      <input type="checkbox" name="linkRelativeLink" id="linkRelativeLink"> Relative Link?
    </label><br><br>
    <label style="display:none;" id="linkBaseUrlLabel" for="linkBaseUrl">Base URL:</label>
    <input style="display:none;" type="text" name="linkBaseUrl" id="linkBaseUrl">
    </details>
    <br><br>
    <details>
      <summary>Date</summary>
      <label for="dateSelector">Date Selector:</label>
      <input type="text" name="dateSelector" id="dateSelector"><br><br>
      <label for="dateAttribute">Date Attribute:</label>
      <input type="text" name="dateAttribute" id="dateAttribute"><br><br>
      <label for="dateFormat">Date Format:</label>
      <input type="text" name="dateFormat" id="dateFormat">
      <label for="dateIterator">
        Date Parent Iterator (optional):
      </label>
      <input type="text" name="dateIterator" id="dateIterator"><br><br>
    </details>
    </div>
    <!-- API Fields -->
  <div id="apiFields" style="display: none;">
    <h3>API Configuration</h3>
    <label for="apiRoute">API Route (Ex: "/dog/breeds"):</label>
    <input type="text" name="apiRoute" id="apiRoute"><br><br>

    <label for="apiMethod">HTTP Method:</label>
    <select name="apiMethod" id="apiMethod">
      <option value="GET">GET</option>
      <option value="POST">POST</option>
    </select><br><br>

    <label for="apiParams">Query Parameters (JSON format):</label><br>
    <textarea name="apiParams" id="apiParams" rows="5" cols="50">{}</textarea><br><br>

    <label for="apiHeaders">HTTP Headers (JSON format):</label><br>
    <textarea name="apiHeaders" id="apiHeaders" rows="5" cols="50">{}</textarea><br><br>

    <label for="apiBody">Request Body (JSON format):</label><br>
    <textarea name="apiBody" id="apiBody" rows="5" cols="50">{}</textarea><br><br>

    <h3>API Response Mapping</h3>
    <label for="apiItemsPath">Items Path (e.g., 'data.items'):</label>
    <input type="text" name="apiItemsPath" id="apiItemsPath"><br><br>

    <label for="apiTitleField">Title Field:</label>
    <input type="text" name="apiTitleField" id="apiTitleField"><br><br>

    <label for="apiDescriptionField">Description Field:</label>
    <input type="text" name="apiDescriptionField" id="apiDescriptionField"><br><br>

    <label for="apiLinkField">Link Field:</label>
    <input type="text" name="apiLinkField" id="apiLinkField"><br><br>

    <label for="apiDateField">Date Field:</label>
    <input type="text" name="apiDateField" id="apiDateField"><br><br>
  </div>
    <br><br>
     <details>
      <summary>Additional Options</summary>
      <label for="refreshTime">Refresh Time (in minutes):</label>
        <input type="text" name="refreshTime" id="refreshTime" min="1" value="5">
      <label>
        <input type="checkbox" name="reverse" id="reverse"> Reverse Order
      </label>
     </details>
     <br><br>
     <div role="group">
     <button type="button" id="previewButton" class="outline contrast">Preview</button>
    <button type="submit" class="outline contrast">Submit</button>
     </div>
  </form>
</main>
<footer>
  <p style="float:left;">Created by <a href="https://github.com/TBosak">Tim Barani</a></p>
  <a style="float:right;" href="/feeds">View Active Feeds</a>
</footer>
<article id="preview" style="display:none;">
  <iframe id="previewFrame" style="width:100%;height:100%;"></iframe>
  <button onclick="document.getElementById('preview').style.display = 'none';" style="width:100%;" class="outline contrast">Hide</button>
</article>
</article>
<script>
    document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('linkRelativeLink').addEventListener('change', function() {
    if (this.checked) {
      document.getElementById('linkBaseUrl').style.display = 'block';
      document.getElementById('linkBaseUrlLabel').style.display = 'block';
    } else {
      document.getElementById('linkBaseUrl').style.display = 'none';
      document.getElementById('linkBaseUrlLabel').style.display = 'none';
    }
  });

  const feedTypeSelect = document.getElementById('feedType');
  const webScrapingFields = document.getElementById('webScrapingFields');
  const apiFields = document.getElementById('apiFields');

  feedTypeSelect.addEventListener('change', function() {
    if (this.value === 'webScraping') {
      webScrapingFields.style.display = 'block';
      apiFields.style.display = 'none';
    } else if (this.value === 'api') {
      webScrapingFields.style.display = 'none';
      apiFields.style.display = 'block';
    }
  });

  document.getElementById('previewButton').addEventListener('click', handlePreview);

  function handlePreview() {
    const form = document.querySelector('form');

// Create a FormData object from the form
const formData = new FormData(form);

// Convert FormData to JSON
const data = {};
  formData.forEach((value, key) => {
    // Handle checkboxes (multiple values)
    if (data[key]) {
      if (!Array.isArray(data[key])) {
        data[key] = [data[key]];
      }
      data[key].push(value);
    } else {
      data[key] = value;
    }
  });

  // Send the AJAX request
  sendPreviewRequest(data);
  }

  function sendPreviewRequest(data) {
  fetch('/preview', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.text(); // Get the RSS feed XML as text
  })
  .then(rssFeedXml => {
    displayPreview(rssFeedXml);
  })
  .catch(error => {
    console.error('Error fetching preview:', error);
    alert('An error occurred while fetching the preview.');
  });
}

function displayPreview(rssFeedXml) {
  const preview = document.getElementById('preview');
  const previewFrame = document.getElementById('previewFrame');

  // Create a Blob from the RSS XML data
  const blob = new Blob([rssFeedXml], { type: 'xml' });
  const blobUrl = URL.createObjectURL(blob);

  // Set the iframe src to the Blob URL
  previewFrame.src = blobUrl;

  // Revoke the Blob URL when the iframe content has loaded
  previewFrame.onload = () => {
    URL.revokeObjectURL(blobUrl);
  };

  // Show the preview
  preview.style.display = 'block';
  window.scrollTo(0, preview.offsetTop);
}
    });
</script>
</body>
</html>